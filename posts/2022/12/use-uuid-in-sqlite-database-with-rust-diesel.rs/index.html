<!doctype html><html lang=en>
<head>
<meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="ie=edge">
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name=author content="Samuel Rodrigues ">
<meta name=description content="Recently in one of my project I ran into a problem where I wanted to use UUIDs in my database but as it turns out SQLite only support 5 data types : TEXT, INTEGER, REAL, NUMERIC and BLOB. This in itself is not really a concern, as I use an ORM (Object-relational mapping) called diesel.rs in my project.
The issue that I encountered is in the ORM itself. The crate diesel.">
<meta name=keywords content=",rust,sqlite,ORM,diesel.rs">
<meta name=robots content="noodp">
<meta name=theme-color content>
<link rel=canonical href=https://obito.fr/posts/2022/12/use-uuid-in-sqlite-database-with-rust-diesel.rs/>
<title>
Use UUID in SQLite database with Rust + Diesel.rs :: Samuel Rodrigues — Portofolio, Thoughts, stories and ideas from my everyday life.
</title>
<link href=https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.5.0/css/flag-icon.min.css rel=stylesheet type=text/css>
<link rel=stylesheet href=https://obito.fr/main.bdcbf93aa7c63ef25db472acbb918a7e5508fa6cf8144fbede904ffb505c0067.css>
<link rel=apple-touch-icon sizes=180x180 href=https://obito.fr/apple-touch-icon.png>
<link rel=icon type=image/png sizes=32x32 href=https://obito.fr/favicon-32x32.png>
<link rel=icon type=image/png sizes=16x16 href=https://obito.fr/favicon-16x16.png>
<link rel=manifest href=https://obito.fr/site.webmanifest>
<link rel=mask-icon href=https://obito.fr/safari-pinned-tab.svg color>
<link rel="shortcut icon" href=https://obito.fr/favicon.ico>
<meta name=msapplication-TileColor content>
<meta itemprop=name content="Use UUID in SQLite database with Rust + Diesel.rs">
<meta itemprop=description content="Recently in one of my project I ran into a problem where I wanted to use UUIDs in my database but as it turns out SQLite only support 5 data types : TEXT, INTEGER, REAL, NUMERIC and BLOB. This in itself is not really a concern, as I use an ORM (Object-relational mapping) called diesel.rs in my project.
The issue that I encountered is in the ORM itself. The crate diesel."><meta itemprop=datePublished content="2022-12-26T19:05:00+01:00">
<meta itemprop=dateModified content="2022-12-26T19:05:00+01:00">
<meta itemprop=wordCount content="452"><meta itemprop=image content="https://obito.fr/">
<meta itemprop=keywords content="rust,sqlite,ORM,diesel.rs,">
<meta name=twitter:card content="summary_large_image">
<meta name=twitter:image content="https://obito.fr/">
<meta name=twitter:title content="Use UUID in SQLite database with Rust + Diesel.rs">
<meta name=twitter:description content="Recently in one of my project I ran into a problem where I wanted to use UUIDs in my database but as it turns out SQLite only support 5 data types : TEXT, INTEGER, REAL, NUMERIC and BLOB. This in itself is not really a concern, as I use an ORM (Object-relational mapping) called diesel.rs in my project.
The issue that I encountered is in the ORM itself. The crate diesel.">
<meta property="og:title" content="Use UUID in SQLite database with Rust + Diesel.rs">
<meta property="og:description" content="Recently in one of my project I ran into a problem where I wanted to use UUIDs in my database but as it turns out SQLite only support 5 data types : TEXT, INTEGER, REAL, NUMERIC and BLOB. This in itself is not really a concern, as I use an ORM (Object-relational mapping) called diesel.rs in my project.
The issue that I encountered is in the ORM itself. The crate diesel.">
<meta property="og:type" content="article">
<meta property="og:url" content="https://obito.fr/posts/2022/12/use-uuid-in-sqlite-database-with-rust-diesel.rs/"><meta property="og:image" content="https://obito.fr/"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2022-12-26T19:05:00+01:00">
<meta property="article:modified_time" content="2022-12-26T19:05:00+01:00"><meta property="og:site_name" content="Samuel Rodrigues">
<meta property="article:published_time" content="2022-12-26 19:05:00 +0100 +0100">
</head>
<body>
<div class=container>
<header class=header>
<span class=header__inner>
<a href=https://obito.fr/ style=text-decoration:none>
<div class=logo>
<span class=logo__mark>></span>
<span class=logo__text>Obito1903</span>
<span class=logo__cursor>
</span>
</div>
</a>
<span class=header__right>
<nav class=menu>
<ul class=menu__inner><li><a href=https://obito.fr/posts>Blog</a></li><li><a href=https://obito.fr/projects>Projects</a></li>
<div class=submenu>
<li class=dropdown>
<a href=javascript:void(0) class=dropbtn>en</a>
<div class=dropdown-content>
</div>
</li>
</div>
</ul>
</nav>
<span class=menu-trigger><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg>
</span>
</span>
</span>
</header>
<div class=content>
<main class=post>
<div class=post-info>
<p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
3 minutes
</p>
</div>
<article>
<h1 class=post-title>
<a href=https://obito.fr/posts/2022/12/use-uuid-in-sqlite-database-with-rust-diesel.rs/>Use UUID in SQLite database with Rust + Diesel.rs</a>
</h1>
<div class=post-content>
<p>Recently in one of my project I ran into a problem where I wanted to use UUIDs in my database but as it turns out SQLite only support 5 data types : <code>TEXT</code>, <code>INTEGER</code>, <code>REAL</code>, <code>NUMERIC</code> and <code>BLOB</code>. This in itself is not really a concern, as I use an ORM (Object-relational mapping) called <a href=https://diesel.rs/>diesel.rs</a> in my project.</p>
<p>The issue that I encountered is in the ORM itself. The crate diesel.rs as an optional feature, allowing the use of the type Uuid from the rust crate uuid. Issue is, this feature only works with PostgreSQL backends, and the only place where it&rsquo;s mentioned is deep in the documentation. So I spent a good amount of time trying to figure out why this feature wasn&rsquo;t working. Anyway, I still wanted to use UUIDs in my database without having to each time explicitly convert it to a type accepted by it.</p>
<p>The solution ? Creating a proxy type to handle the magic for me :</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=color:#66d9ef>use</span> diesel::deserialize::{self, FromSql};
<span style=color:#66d9ef>use</span> diesel::serialize::{self, Output, ToSql};
<span style=color:#66d9ef>use</span> diesel::sql_types::Binary;
<span style=color:#66d9ef>use</span> diesel::sqlite::Sqlite;
<span style=color:#66d9ef>use</span> diesel::{AsExpression, FromSqlRow};
<span style=color:#66d9ef>use</span> std::fmt;
<span style=color:#66d9ef>use</span> std::fmt::{Display, Formatter};
<span style=color:#66d9ef>use</span> uuid;

<span style=color:#75715e>#[derive(Debug, Clone, Copy, FromSqlRow, AsExpression, Hash, Eq, PartialEq)]</span>
<span style=color:#75715e>#[sql_type = </span><span style=color:#e6db74>&#34;Binary&#34;</span><span style=color:#75715e>]</span>
<span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>UUID</span>(<span style=color:#66d9ef>pub</span> uuid::Uuid);

<span style=color:#75715e>// Small function to easily initialize our uuid
</span><span style=color:#75715e></span><span style=color:#66d9ef>impl</span> UUID {
    <span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>random</span>() -&gt; <span style=color:#a6e22e>Self</span> {
        Self(uuid::Uuid::new_v4())
    }
}

<span style=color:#75715e>// Allow easy conversion from UUID to the wanted uuid::Uuid
</span><span style=color:#75715e></span><span style=color:#66d9ef>impl</span> From<span style=color:#f92672>&lt;</span>UUID<span style=color:#f92672>&gt;</span> <span style=color:#66d9ef>for</span> uuid::Uuid {
    <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>from</span>(s: <span style=color:#a6e22e>UUID</span>) -&gt; <span style=color:#a6e22e>Self</span> {
        s.<span style=color:#ae81ff>0</span>
    }
}

<span style=color:#66d9ef>impl</span> Display <span style=color:#66d9ef>for</span> UUID {
    <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>fmt</span>(<span style=color:#f92672>&amp;</span>self, f: <span style=color:#66d9ef>&amp;</span><span style=color:#a6e22e>mut</span> Formatter<span style=color:#f92672>&lt;&#39;</span>_<span style=color:#f92672>&gt;</span>) -&gt; <span style=color:#a6e22e>fmt</span>::Result {
        write!(f, <span style=color:#e6db74>&#34;{}&#34;</span>, self.<span style=color:#ae81ff>0</span>)
    }
}

<span style=color:#75715e>// Convert binary data from SQLite to a UUID
</span><span style=color:#75715e></span><span style=color:#66d9ef>impl</span> FromSql<span style=color:#f92672>&lt;</span>Binary, Sqlite<span style=color:#f92672>&gt;</span> <span style=color:#66d9ef>for</span> UUID {
    <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>from_sql</span>(bytes: <span style=color:#a6e22e>diesel</span>::backend::RawValue<span style=color:#f92672>&lt;&#39;</span>_, Sqlite<span style=color:#f92672>&gt;</span>) -&gt; <span style=color:#a6e22e>deserialize</span>::Result<span style=color:#f92672>&lt;</span>Self<span style=color:#f92672>&gt;</span> {
        <span style=color:#66d9ef>let</span> bytes <span style=color:#f92672>=</span> <span style=color:#f92672>&lt;*</span><span style=color:#66d9ef>const</span> [<span style=color:#66d9ef>u8</span>] <span style=color:#66d9ef>as</span> FromSql<span style=color:#f92672>&lt;</span>Binary, Sqlite<span style=color:#f92672>&gt;&gt;</span>::from_sql(bytes)<span style=color:#f92672>?</span>;
        <span style=color:#66d9ef>let</span> bytes <span style=color:#f92672>=</span> <span style=color:#66d9ef>unsafe</span> { <span style=color:#f92672>&amp;*</span>bytes };
        <span style=color:#66d9ef>let</span> uuid <span style=color:#f92672>=</span> uuid::Uuid::from_slice(bytes).map_err(<span style=color:#f92672>|</span>_<span style=color:#f92672>|</span> <span style=color:#e6db74>&#34;Invalid UUID&#34;</span>)<span style=color:#f92672>?</span>;
        Ok(UUID(uuid))
    }
}

<span style=color:#75715e>// Convert UUID to binary data for SQLite
</span><span style=color:#75715e></span><span style=color:#66d9ef>impl</span> ToSql<span style=color:#f92672>&lt;</span>Binary, Sqlite<span style=color:#f92672>&gt;</span> <span style=color:#66d9ef>for</span> UUID {
    <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>to_sql</span><span style=color:#f92672>&lt;&#39;</span><span style=color:#a6e22e>b</span><span style=color:#f92672>&gt;</span>(<span style=color:#f92672>&amp;&#39;</span><span style=color:#a6e22e>b</span> self, out: <span style=color:#66d9ef>&amp;</span><span style=color:#a6e22e>mut</span> Output<span style=color:#f92672>&lt;&#39;</span><span style=color:#a6e22e>b</span>, <span style=color:#f92672>&#39;</span>_, Sqlite<span style=color:#f92672>&gt;</span>) -&gt; <span style=color:#a6e22e>serialize</span>::Result {
        Ok(<span style=color:#f92672>&lt;</span>[<span style=color:#66d9ef>u8</span>] <span style=color:#66d9ef>as</span> ToSql<span style=color:#f92672>&lt;</span>Binary, Sqlite<span style=color:#f92672>&gt;&gt;</span>::to_sql(
            self.<span style=color:#ae81ff>0.</span>as_bytes(),
            out,
        )<span style=color:#f92672>?</span>)
    }
}
</code></pre></div><p>With that, we just need to use the <code>BLOB</code> type to store UUID as raw binary data in SQLite :</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TABLE</span> tags (
    uuid BLOB <span style=color:#66d9ef>PRIMARY</span> <span style=color:#66d9ef>KEY</span> <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>NULL</span>,
    name TEXT <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>NULL</span> <span style=color:#66d9ef>UNIQUE</span>,

    created_at DATETIME <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>NULL</span> <span style=color:#66d9ef>DEFAULT</span> <span style=color:#66d9ef>CURRENT_TIMESTAMP</span>,
    updated_at DATETIME <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>NULL</span> <span style=color:#66d9ef>DEFAULT</span> <span style=color:#66d9ef>CURRENT_TIMESTAMP</span>
);
</code></pre></div><p>And finally, use our new <code>UUID</code> type in our rust code :</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=color:#75715e>#[derive(Queryable, Debug)]</span>
<span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>Tag</span> {
    <span style=color:#66d9ef>pub</span> id: <span style=color:#a6e22e>UUID</span>,
    <span style=color:#66d9ef>pub</span> name: String,
    <span style=color:#66d9ef>pub</span> display_name: String,
    <span style=color:#66d9ef>pub</span> created_at: <span style=color:#a6e22e>NaiveDateTime</span>,
    <span style=color:#66d9ef>pub</span> updated_at: <span style=color:#a6e22e>NaiveDateTime</span>,
}

<span style=color:#75715e>#[derive(Insertable)]</span>
<span style=color:#75715e>#[diesel(table_name = tags)]</span>
<span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>NewTag</span><span style=color:#f92672>&lt;&#39;</span><span style=color:#a6e22e>a</span><span style=color:#f92672>&gt;</span> {
    <span style=color:#66d9ef>pub</span> uuid: <span style=color:#66d9ef>&amp;</span><span style=color:#f92672>&#39;</span><span style=color:#a6e22e>a</span> <span style=color:#a6e22e>UUID</span>,
    <span style=color:#66d9ef>pub</span> name: <span style=color:#66d9ef>&amp;</span><span style=color:#f92672>&#39;</span><span style=color:#a6e22e>a</span> <span style=color:#66d9ef>str</span>,
    <span style=color:#66d9ef>pub</span> display_name: <span style=color:#66d9ef>&amp;</span><span style=color:#f92672>&#39;</span><span style=color:#a6e22e>a</span> <span style=color:#66d9ef>str</span>,
    <span style=color:#66d9ef>pub</span> created_at: <span style=color:#66d9ef>&amp;</span><span style=color:#f92672>&#39;</span><span style=color:#a6e22e>a</span> <span style=color:#a6e22e>NaiveDateTime</span>,
    <span style=color:#66d9ef>pub</span> updated_at: <span style=color:#66d9ef>&amp;</span><span style=color:#f92672>&#39;</span><span style=color:#a6e22e>a</span> <span style=color:#a6e22e>NaiveDateTime</span>,
}
</code></pre></div>
</div>
</article>
<hr>
<div class=post-info>
<p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7" y2="7"/></svg>
<span class=tag><a href=https://obito.fr/tags/rust/>rust</a></span>
<span class=tag><a href=https://obito.fr/tags/sqlite/>sqlite</a></span>
<span class=tag><a href=https://obito.fr/tags/orm/>ORM</a></span>
<span class=tag><a href=https://obito.fr/tags/diesel.rs/>diesel.rs</a></span>
</p>
<p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6A2 2 0 004 4v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>
452 Words
</p>
<p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
2022-12-26 18:05
</p>
</div>
<div class=pagination>
<div class=pagination__title>
<span class=pagination__title-h>Read other posts</span>
<hr>
</div>
<div class=pagination__buttons>
<span class="button next">
<a href=https://obito.fr/posts/2022/01/control-your-hi-fi-setup-with-home-assistant-and-an-ir-esp01/>
<span class=button__text>Control your HI-FI setup with Home-assistant and an IR-ESP01</span>
<span class=button__icon>→</span>
</a>
</span>
</div>
</div>
</main>
</div>
<footer class=footer>
<div class=footer__inner>
<div class=footer__content>
<span><a href=https://obito.fr/>Samuel Rodrigues</a></span>
<span><a href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank rel=noopener>CC BY-NC 4.0</a></span>
<span><a href=https://obito.fr/%20posts/index.xml target=_blank title=rss><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 20 20" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 019 9"/><path d="M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></svg></a></span>
</div>
</div>
<div class=footer__inner>
<div class=footer__content>
<span>Powered by <a href=http://gohugo.io>Hugo</a></span><span>Made with &#10084; by <a href=https://github.com/obito1903>Obito1903</a></span>
</div>
</div>
</footer>
</div>
<script type=text/javascript src=https://obito.fr/bundle.min.617ca242d692c44a5b9d7d50bb64ecba7c8e8b8e27c8d46ada65aa90950dfd263fdf84787e4c894121633d2ca72c37cddc1defd82020753f6dfa812387c1139d.js integrity="sha512-YXyiQtaSxEpbnX1Qu2TsunyOi44nyNRq2mWqkJUN/SY/34R4fkyJQSFjPSynLDfN3B3v2CAgdT9t+oEjh8ETnQ=="></script>
<script defer data-domain=obito.fr src=https://plausible.obito.fr/js/script.js></script>
</body>
</html>